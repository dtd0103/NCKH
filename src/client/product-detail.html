<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>pussea</title>

        <!-- Favicon -->
        <link
            rel="apple-touch-icon"
            sizes="76x76"
            href="./assets/favicon/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="./assets/favicon/favicon-32x32.png"
        />

        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="./assets/favicon/favicon-16x16.png"
        />
        <link rel="manifest" href="./assets/favicon/site.webmanifest" />
        <meta name="msapplication-TileColor" content="#da532c" />
        <meta name="theme-color" content="#ffffff" />

        <!-- Fonts -->
        <link rel="stylesheet" href="./assets/fonts/stylesheet.css" />

        <!-- Styles -->

        <link rel="icon" href="./assets/image/img1.png" type="image/x-icon" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        />
        <link rel="stylesheet" href="./assets/css/base.css" />
        <link rel="stylesheet" href="./assets/css/header.css" />
        <link rel="stylesheet" href="./assets/css/grid.css" />
        <link
            rel="stylesheet"
            href="./assets/fonts/fontawesome-free-5.15.3/css/all.min.css"
        />
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.4.2/gsap.min.js"></script>
        <link rel="stylesheet" href="./assets/css/style.css" />
        <!-- Scripts -->
        <script src="./assets/js/scripts.js"></script>
        <script src="./assets/js/main.js"></script>
    </head>
    <body>
        <!-- Header -->
        <header id="header" class="header"></header>
        <script>
            load("#header", "./templates/header2.html");
        </script>

        <!-- MAIN -->
        <main class="product-page">
            <div class="container">
                <!-- Search bar -->
                <div class="product-container">
                    <div class="search-bar d-none d-md-flex">
                        <input
                            type="text"
                            name=""
                            id=""
                            placeholder="Search for item"
                            class="search-bar__input"
                        />
                        <button class="search-bar__submit">
                            <img
                                src="./assets/icons/search.svg"
                                alt=""
                                class="search-bar__icon icon"
                            />
                        </button>
                    </div>
                </div>

                <!-- Breadcrumbs -->
                <div class="product-container">
                    <ul class="breadcrumbs checkout-page__breadcrumbs">
                        <li>
                            <a href="./" class="breadcrumbs__link">
                                Trang chủ
                                <img
                                    src="./assets/icons/arrow-right.svg"
                                    alt=""
                                />
                            </a>
                        </li>
                        <li>
                            <a
                                href="#"
                                onclick="goBack()"
                                class="breadcrumbs__link"
                                id="category"
                            >
                            </a>
                        </li>
                        <img src="./assets/icons/arrow-right.svg" alt="" />
                        <li>
                            <a
                                href="#!"
                                class="breadcrumbs__link breadcrumbs__link--current product-name"
                            >
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Product info -->
                <div class="product-container prod-info-content">
                    <div class="row">
                        <div class="col-5 col-xl-6 col-lg-12">
                            <div class="prod-preview">
                                <div class="prod-preview__list">
                                    <div class="prod-preview__item">
                                        <img
                                            src=""
                                            alt=""
                                            class="prod-preview__img"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-7 col-xl-6 col-lg-12">
                            <form action="" class="form">
                                <section class="prod-info">
                                    <p
                                        class="prod-info__heading"
                                        id="product-category"
                                        style="
                                            font-size: 3rem;
                                            font-weight: bold;
                                        "
                                    ></p>
                                    <h1
                                        style="font-size: 2.5rem"
                                        class="prod-info__heading product-name"
                                    ></h1>
                                    <p
                                        style="
                                            font-size: 2.5rem;
                                            color: #9e9da8;
                                            font-style: italic;
                                        "
                                        class="prod-info__heading"
                                        id="product-brand"
                                    ></p>
                                    <div class="row">
                                        <div class="col-7 col-xxl-6 col-xl-12">
                                            <div class="prod-props">
                                                <div class="prod-prop">
                                                    <img
                                                        src="./assets/icons/buy.svg"
                                                        alt=""
                                                        class="prod-prop__icon icon"
                                                    />
                                                    <div>
                                                        <h4
                                                            class="prod-prop__title"
                                                        >
                                                            Vận chuyển
                                                        </h4>
                                                        <p
                                                            class="prod-prop__desc"
                                                        >
                                                            Từ $6 trong 1-3 ngày
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="prod-prop">
                                                    <img
                                                        src="./assets/icons/bag.svg"
                                                        alt=""
                                                        class="prod-prop__icon icon"
                                                    />
                                                    <div>
                                                        <h4
                                                            class="prod-prop__title"
                                                        >
                                                            Pickup
                                                        </h4>
                                                        <p
                                                            class="prod-prop__desc"
                                                            id="prod-prop__desc"
                                                        ></p>
                                                    </div>
                                                </div>
                                                <div class="prod-info__card">
                                                    <p>Giá sản phẩm:</p>
                                                    <p
                                                        class="prod-info__total-price"
                                                        id="product-price"
                                                    ></p>
                                                    <div class="prod-info__row">
                                                        <button
                                                            style="
                                                                max-width: 200px;
                                                            "
                                                            class="btn btn--primary-prod prod-info__add-to-cart"
                                                            data-id="${product.SP_Ma}"
                                                        >
                                                            Thêm vào giỏ
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Product content -->
                <div class="product-container">
                    <div class="prod-tab js-tabs">
                        <ul class="prod-tab__list">
                            <li class="prod-tab__item prod-tab__item--current">
                                Mô tả
                            </li>
                            <li class="prod-tab__item">Liên quan</li>
                        </ul>
                        <div class="prod-tab__contents">
                            <div
                                class="prod-tab__content prod-tab__content--current"
                            >
                                <div class="row">
                                    <div class="col-8 col-xl-10 col-lg-12">
                                        <div
                                            class="text-content prod-tab__text-content"
                                        >
                                            <p id="product-description"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="prod-tab__content">
                                <div class="prod-content">
                                    <h2 class="prod-content__heading">
                                        Có thể bạn sẽ thích
                                    </h2>
                                    <div
                                        class="row row-cols-6 row-cols-xl-4 row-cols-lg-3 row-cols-md-2 row-cols-sm-1 g-2"
                                    >
                                        <div class="col">
                                            <a href="./product-detail.html">
                                                <article class="product-card">
                                                    <div
                                                        class="product-card__img-wrap"
                                                    >
                                                        <a
                                                            href="./product-detail.html"
                                                        >
                                                            <img
                                                                src="./assets/img/product/nikebag.png"
                                                                alt=""
                                                                class="product-card__thumb"
                                                            />
                                                        </a>
                                                        <!-- <button class="like-btn product-card__like-btn">
                                                            <img src="./assets/icons/heart.svg" alt="" class="like-btn__icon icon" />
                                                            <img src="./assets/icons/heart-red.svg" alt="" class="like-btn__icon--liked" />
                                                        </button> -->
                                                    </div>
                                                    <h3
                                                        class="product-card__title"
                                                    >
                                                        <a
                                                            href="./product-detail.html"
                                                            >Túi xách - Gym
                                                            Tote</a
                                                        >
                                                    </h3>
                                                    <p
                                                        class="product-card__brand"
                                                    >
                                                        Nike
                                                    </p>
                                                    <div
                                                        class="product-card__row"
                                                    >
                                                        <span
                                                            class="product-card__price"
                                                            >$47.00</span
                                                        >
                                                        <div
                                                            class="product-card__rating"
                                                        >
                                                            <img
                                                                src="./assets/icons/star.svg"
                                                                alt=""
                                                                class="product-card__star"
                                                            />
                                                            <img
                                                                src="./assets/icons/star.svg"
                                                                alt=""
                                                                class="product-card__star"
                                                            />
                                                            <img
                                                                src="./assets/icons/star.svg"
                                                                alt=""
                                                                class="product-card__star"
                                                            />
                                                            <img
                                                                src="./assets/icons/star.svg"
                                                                alt=""
                                                                class="product-card__star"
                                                            />
                                                            <img
                                                                src="./assets/icons/star-half.svg"
                                                                alt=""
                                                                class="product-card__star"
                                                            />
                                                            <span
                                                                class="product-card__score"
                                                                >4.3</span
                                                            >
                                                        </div>
                                                    </div>
                                                </article>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer id="footer" class="footer"></footer>
        <script>
            load("#footer", "./templates/footer.html");
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get("id");

                if (productId) {
                    try {
                        const productApiUrl = `http://localhost:8081/api/v1/product/id/${productId}`;
                        const response = await fetch(productApiUrl, {
                            method: "GET",
                            credentials: "include",
                        });
                        const product = await response.json();

                        document.getElementById(
                            "product-category"
                        ).textContent =
                            product.DM_Ten.charAt(0).toUpperCase() +
                            product.DM_Ten.slice(1);

                        document
                            .querySelectorAll(".product-name")
                            .forEach((element) => {
                                element.textContent =
                                    product.SP_Ten.charAt(0).toUpperCase() +
                                    product.SP_Ten.slice(1);
                            });

                        document.getElementById(
                            "product-price"
                        ).textContent = `${product.SP_DonGia}$`;
                        let productImg = `http://localhost:8081/images/product/${product.SP_HinhAnh}`;
                        const imgElement =
                            document.querySelector(".prod-preview__img");
                        imgElement.src = productImg;

                        document.getElementById(
                            "product-description"
                        ).textContent = product.SP_ThongTin;

                        document.getElementById(
                            "prod-prop__desc"
                        ).textContent = `Còn lại ${product.SP_SoLuong} sản phẩm`;

                        document.getElementById(
                            "category"
                        ).textContent = `${product.DM_Ten.charAt(
                            0
                        ).toUpperCase()}${product.DM_Ten.slice(1)}`;

                        document.getElementById(
                            "product-brand"
                        ).textContent = `${product.TH_Ten.charAt(
                            0
                        ).toUpperCase()}${product.TH_Ten.slice(1)}`;

                        // Hàm để lưu số sản phẩm vào localStorage
                        function saveProductCount() {
                            const existingProducts =
                                JSON.parse(
                                    localStorage.getItem("productIds")
                                ) || [];
                            const count = existingProducts.length;
                            localStorage.setItem("productCount", count);
                        }

                        // Thêm sự kiện click vào nút "Thêm vào giỏ"
                        const addToCartButton = document.querySelector(
                            ".prod-info__add-to-cart"
                        );
                        addToCartButton.addEventListener(
                            "click",
                            function (event) {
                                event.preventDefault(); // Ngăn chặn hành động mặc định

                                const existingProducts =
                                    JSON.parse(
                                        localStorage.getItem("productIds")
                                    ) || [];

                                // Thêm product.SP_Ma vào localStorage mà không kiểm tra trùng lặp
                                existingProducts.push(product.SP_Ma);
                                localStorage.setItem(
                                    "productIds",
                                    JSON.stringify(existingProducts)
                                );

                                // Lưu số sản phẩm vào localStorage
                                saveProductCount();
                            }
                        );
                    } catch (err) {
                        console.error("Lỗi: ", err);
                    }
                }
            });

            document.addEventListener("DOMContentLoaded", async function () {
                const params = new URLSearchParams(window.location.search);
                const productId = params.get("id");

                if (productId) {
                    console.log("Product ID:", productId);
                    await trackProductView(productId);
                }

                async function trackProductView(productId) {
                    console.log("Request body:", { productId }); // Log the request body

                    try {
                        const response = await fetch(
                            "http://localhost:8081/api/v1/product/view",
                            {
                                method: "POST",
                                credentials: "include",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({ productId }),
                            }
                        );

                        if (!response.ok) {
                            throw new Error(
                                "Network response was not ok: " +
                                    response.statusText
                            );
                        }

                        const data = await response.json();
                        console.log(data.message);
                    } catch (error) {
                        console.error("Error tracking product view:", error);
                    }
                }
            });
        </script>
    </body>
</html>
