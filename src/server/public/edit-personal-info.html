<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chỉnh sửa thông tin | RecomMall</title>

    <!-- Favicon -->
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="./assets/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./assets/favicon/favicon-32x32.png"
    />

    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./assets/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="./assets/favicon/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />

    <!-- Fonts -->
    <link rel="stylesheet" href="./assets/fonts/stylesheet.css" />

    <!-- Styles -->

    <link rel="icon" href="./assets/image/img1.png" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link rel="stylesheet" href="./assets/css/base.css" />
    <link rel="stylesheet" href="./assets/css/header.css" />
    <link rel="stylesheet" href="./assets/css/grid.css" />
    <link rel="stylesheet" href="./assets/css/shipping.css" />
    <link
      rel="stylesheet"
      href="./assets/fonts/fontawesome-free-5.15.3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.4.2/gsap.min.js"></script>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <!-- Scripts -->
    <script src="./assets/js/scripts.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/edit-personal-info.js"></script>
    <script src="./assets/js/profile.js"></script>
  </head>
  <body>
    <!-- Header -->
    <header id="header" class="header"></header>
    <script>
      load("#header", "./templates/header2-logined.html");
    </script>
    <!-- MAIN -->
    <main class="profile">
      <div class="container">
        <!-- Search bar -->
        <div class="profile-container">
          <div class="search-bar d-none d-md-flex">
            <input
              type="text"
              name=""
              id=""
              placeholder="Search for item"
              class="search-bar__input"
            />
            <button class="search-bar__submit">
              <img
                src="./assets/icons/search.svg"
                alt=""
                class="search-bar__icon icon"
              />
            </button>
          </div>
        </div>
        <div class="checkout-container">
          <ul class="breadcrumbs checkout-page__breadcrumbs">
            <li>
              <a href="./" class="breadcrumbs__link">
                Trang chủ
                <img src="./assets/icons/arrow-right.svg" alt="" />
              </a>
            </li>
            <li>
              <a href="./profile.html" class="breadcrumbs__link">
                Hồ sơ
                <img src="./assets/icons/arrow-right.svg" alt="" />
              </a>
            </li>
            <li>
              <a href="#!" class="breadcrumbs__link breadcrumbs__link--current"
                >Thông tin cá nhân</a
              >
            </li>
          </ul>
        </div>
        <!-- Profile content -->
        <div class="profile-container">
          <div class="row gy-md-3">
            <div class="col-9 col-xl-8 col-lg-12" style="padding-right: 0">
              <div class="cart-info">
                <div class="row gy-3">
                  <div class="col-12">
                    <h2 class="cart-info__heading">
                      <a href="./profile.html">
                        <img
                          src="./assets/icons/arrow-left.svg"
                          alt=""
                          class="icon cart-info__back-arrow"
                        />
                      </a>
                      Thông tin cá nhân
                    </h2>
                    <form action="./profile.html" class="form form-card">
                      <!-- Form row 1 -->
                      <div class="form__row">
                        <div class="form__group">
                          <label
                            for="full-name"
                            class="form__label form-card__label"
                            >Họ tên</label
                          >
                          <div class="form__text-input">
                            <input
                              type="text"
                              id="full-name"
                              placeholder="Họ và tên"
                              class="form__input"
                              required
                              autofocus
                            />
                            <img
                              src="./assets/icons/form-error.svg"
                              alt=""
                              class="form__input-icon-error"
                            />
                          </div>
                          <p class="form__error">Tên không được để trống</p>
                        </div>
                        <div class="form__group">
                          <label
                            for="address"
                            class="form__label form-card__label"
                            >Địa chỉ</label
                          >
                          <div class="form__text-input">
                            <input
                              type="text"
                              id="address"
                              placeholder="Địa chỉ"
                              class="form__input"
                              required
                            />
                            <img
                              src="./assets/icons/form-error.svg"
                              alt=""
                              class="form__input-icon-error"
                            />
                          </div>
                          <p class="form__error">Địa chỉ không được để trống</p>
                        </div>
                      </div>

                      <!-- Form row 2 -->
                      <div class="form__row">
                        <div class="form__group">
                          <label
                            for="username"
                            class="form__label form-card__label"
                            >Tên đăng nhập</label
                          >
                          <div class="form__text-input">
                            <input
                              type="text"
                              id="username"
                              placeholder="Tên đăng nhập"
                              class="form__input"
                              minlength="6"
                              required
                            />
                            <img
                              src="./assets/icons/form-error.svg"
                              alt=""
                              class="form__input-icon-error"
                            />
                          </div>
                          <p class="form__error">Tên đăng nhập có ít 6 ký tự</p>
                        </div>
                        <div class="form__group">
                          <label
                            for="phone-number"
                            class="form__label form-card__label"
                            >Số điện thoại</label
                          >
                          <div class="form__text-input">
                            <input
                              type="text"
                              id="phone-number"
                              placeholder="Số điện thoại"
                              class="form__input"
                              required
                            />
                            <img
                              src="./assets/icons/form-error.svg"
                              alt=""
                              class="form__input-icon-error"
                            />
                          </div>
                          <p class="form__error">
                            Số điện thoại không được bỏ trống
                          </p>
                        </div>
                      </div>

                      <!-- Form row 3 -->
                      <!-- <div class="form__row">
                        <div class="form__group">
                          <label
                            for="password"
                            class="form__label form-card__label"
                            >Mật khẩu</label
                          >
                          <div class="form__text-input">
                            <input
                              type="password"
                              id="password"
                              placeholder="Mật khẩu"
                              class="form__input"
                              required
                            />
                            <img
                              src="./assets/icons/form-error.svg"
                              alt=""
                              class="form__input-icon-error"
                            />
                          </div>
                          <p class="form__error">
                            Mật khẩu không được bỏ trống
                          </p>
                        </div>
                      </div> -->

                      <div class="form-card__bottom">
                        <a class="btn btn--text" href="./profile.html">Hủy</a>
                        <button
                          class="btn btn--small btn--primary modal__btn btn--no-margin"
                          type="submit"
                        >
                          Lưu
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-3 col-xl-4 d-lg-none" style="padding-left: 0">
              <aside class="profile__sidebar">
                <!-- User -->
                <div class="profile-user">
                  <img
                    src="./assets/img/avatar/avatar-3.png"
                    alt=""
                    class="profile-user__avatar"
                  />
                  <h1 class="profile-user__name" id="profile-name"></h1>
                  <p class="profile-user__desc" id="profile-username">bleble</p>
                </div>

                <!-- Menu 1 -->
                <div class="profile-menu">
                  <h3 class="profile-menu__title">Quản lý tài khoản</h3>
                  <ul class="profile-menu__list">
                    <li>
                      <a
                        href="./edit-personal-info.html"
                        class="profile-menu__link"
                      >
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/profile.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Thông tin cá nhân
                      </a>
                    </li>
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/location.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Địa chỉ
                      </a>
                    </li>
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/message-2.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Giao tiếp & Bảo mật thông tin
                      </a>
                    </li>
                  </ul>
                </div>

                <!-- Menu 2 -->
                <div class="profile-menu">
                  <h3 class="profile-menu__title">Sản phẩm</h3>
                  <ul class="profile-menu__list">
                    <li>
                      <a href="./orders.html" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/checkout.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Đơn hàng đã đặt
                      </a>
                    </li>
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/heart.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Yêu thích
                      </a>
                    </li>
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/gift-2.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Mã khuyến mãi
                      </a>
                    </li>
                  </ul>
                </div>

                <!-- Menu 3 -->
                <div class="profile-menu">
                  <h3 class="profile-menu__title">Đăng ký thành viên</h3>
                  <ul class="profile-menu__list">
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/shield.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Quyền lợi khách hàng
                      </a>
                    </li>
                  </ul>
                </div>

                <!-- Menu 4 -->
                <div class="profile-menu">
                  <h3 class="profile-menu__title">Dịch vụ khách hàng</h3>
                  <ul class="profile-menu__list">
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/info.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Trợ giúp
                      </a>
                    </li>
                    <li>
                      <a href="#!" class="profile-menu__link">
                        <span class="profile-menu__icon">
                          <img
                            src="./assets/icons/danger.svg"
                            alt=""
                            class="icon"
                          />
                        </span>
                        Hướng dẫn
                      </a>
                    </li>
                  </ul>
                </div>
              </aside>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer id="footer" class="footer"></footer>
    <script>
      load("#footer", "./templates/footer.html");
      // =========chỉnh sửa thông tin cá nhân
      window.onload = async function () {
    const username = localStorage.getItem("username"); 

    if (!username) {
        alert("Không có thông tin username trong localStorage.");
        return;
    }

    try {
        const response = await fetch(`http://localhost:8081/api/v1/customer/${username}`);

        if (!response.ok) {
            throw new Error(`Lỗi khi lấy thông tin khách hàng: ${response.status}`);
        }

        const customerData = await response.json();

        // Điền thông tin vào form
        document.getElementById("full-name").value = customerData.KH_Ten;
        document.getElementById("address").value = customerData.KH_DiaChi;
        document.getElementById("username").value = customerData.KH_TaiKhoan;
        document.getElementById("phone-number").value = customerData.KH_SoDienThoai;

        // Lưu mật khẩu hiện tại vào biến toàn cục để dùng sau
        window.currentPassword = customerData.KH_MatKhau;

        // Cập nhật giao diện hồ sơ
        document.getElementById("profile-name").textContent = customerData.KH_Ten;
        document.getElementById("profile-username").textContent = "@" + customerData.KH_TaiKhoan;
    } catch (error) {
        console.error("Lỗi khi lấy thông tin khách hàng:", error);
        alert("Không thể lấy thông tin khách hàng. Vui lòng thử lại sau.");
    }
};

// Lắng nghe sự kiện submit form để cập nhật thông tin khách hàng
document.querySelector(".form").addEventListener("submit", async function (event) {
    event.preventDefault(); // Ngăn không cho form submit mặc định

    const username = localStorage.getItem("username");

    if (!username) {
        alert("Không có thông tin username trong localStorage.");
        return;
    }

    // Lấy giá trị mới từ form
    const fullName = document.getElementById("full-name").value;
    const address = document.getElementById("address").value;
    const newUsername = document.getElementById("username").value;
    const phoneNumber = document.getElementById("phone-number").value;

    // Kiểm tra nếu form có giá trị bị thiếu
    if (!fullName || !address || !newUsername || !phoneNumber) {
        alert("Vui lòng điền đầy đủ thông tin.");
        return;
    }

    // Chuẩn bị dữ liệu cập nhật
    let updatedCustomerData = {
        id: null, // Cần fetch lại id
        name: fullName,
        address: address,
        username: newUsername,
        phone: phoneNumber,
        password: window.currentPassword, // Giữ nguyên mật khẩu cũ
    };

    // Fetch để lấy id từ username
    try {
        const fetchResponse = await fetch(`http://localhost:8081/api/v1/customer/${username}`);
        const customer = await fetchResponse.json();
        updatedCustomerData.id = customer.KH_Ma;
    } catch (error) {
        console.error("Lỗi khi lấy thông tin khách hàng:", error);
        alert("Không thể lấy thông tin khách hàng.");
        return;
    }

    // Gửi request cập nhật thông tin khách hàng
    try {
        const response = await fetch("http://localhost:8081/api/v1/customer", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("authToken")}`,
            },
            body: JSON.stringify(updatedCustomerData),
        });

        const responseText = await response.text(); // Đọc phản hồi dưới dạng text

        if (!response.ok) {
            throw new Error(`Lỗi khi cập nhật thông tin: ${response.status}`);
        }

        try {
            JSON.parse(responseText); // Kiểm tra phản hồi có phải JSON không
            alert("Cập nhật thông tin thành công!");
        } catch (jsonError) {
            alert(responseText); // Nếu không phải JSON, hiển thị thông điệp từ server
        }

        window.location.href = "./profile.html"; // Điều hướng về trang profile
    } catch (error) {
        console.error("Lỗi khi cập nhật thông tin:", error);
        alert("Đã xảy ra lỗi khi cập nhật thông tin. Vui lòng thử lại.");
    }
});


    </script>
  </body>
</html>
